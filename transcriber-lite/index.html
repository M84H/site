<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Japanese Transcription Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .panel {
            margin-bottom: 30px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px;
            line-height: 1.8;
            resize: vertical;
            transition: border-color 0.2s;
            font-family: 'MS Mincho', 'Yu Mincho', serif;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        #historicalInput.font-loaded {
            font-family: 'IPAmj Mincho', 'MS Mincho', 'Yu Mincho', serif;
        }

        #modernOutput {
            background: #f8f9fa;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-size: 14px;
            color: #555;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-size: 14px;
            color: #856404;
        }

        .char-count {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .status.ready {
            background: #d4edda;
            color: #155724;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .font-load-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .font-load-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .font-load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .font-info {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .character-picker {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .character-picker.collapsed {
            max-height: 60px;
            overflow: hidden;
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .picker-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .toggle-picker {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .toggle-picker:hover {
            background: #5568d3;
        }

        .kana-group {
            margin-bottom: 16px;
        }

        .kana-group-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #e0e0e0;
        }

        .kana-chars {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .kana-char {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            font-family: 'IPAmj Mincho', 'MS Mincho', serif;
        }

        .kana-char:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .kana-char:active {
            transform: scale(0.95);
        }

        .picker-search {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .picker-search:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìú Historical Japanese Transcription Tool</h1>
            <p>Convert manuscripts with variant kana (Â§â‰Ωì‰ªÆÂêç) to modern Japanese orthography</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>üí° How to use:</strong> Click "Load Font" below, then type or paste your historical Japanese text. The tool will convert hentaigana and historical characters to modern standard Japanese.
            </div>

            <div class="info-box" style="border-left-color: #6c757d; background: #f8f9fa;">
                <strong>üìÑ Font License:</strong> This tool uses the IPAmj Mincho font, which is licensed under the <a href="https://moji.or.jp/ipafont/license/" target="_blank" style="color: #667eea; text-decoration: underline;">IPA Font License v1.0</a>. 
                The font is provided by the <a href="https://moji.or.jp/mojikiban/font/" target="_blank" style="color: #667eea; text-decoration: underline;">Information-technology Promotion Agency, Japan (IPA)</a>.
                ¬© 2011-2019 Information-technology Promotion Agency, Japan (IPA)
            </div>

            <div id="fontWarning" class="warning-box">
                <strong>‚ö†Ô∏è Font Not Loaded:</strong> The IPAmj Mincho font (29.8MB) needs to be loaded to display historical characters correctly. 
                <div class="font-info">This is a one-time download that will be cached by your browser for future visits.</div>
                <button class="font-load-btn" id="loadFontBtn" onclick="loadFont()">üì• Load IPAmj Mincho Font (29.8MB)</button>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="font-info" id="fontLoadStatus"></div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="convertText()">üîÑ Convert to Modern Japanese</button>
                <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
                <button class="btn btn-secondary" onclick="swapTexts()">‚áÑ Swap</button>
                <button class="btn btn-secondary" onclick="downloadBoth()">üíæ Download Both</button>
            </div>

            <div class="character-picker" id="characterPicker">
                <div class="picker-header">
                    <span class="picker-title">üî§ Hentaigana Character Picker</span>
                    <button class="toggle-picker" onclick="togglePicker()">Collapse ‚ñ≤</button>
                </div>
                <input type="text" class="picker-search" id="pickerSearch" placeholder="Search by modern kana (e.g., '„ÅÇ', '„Åã')..." oninput="filterCharacters()">
                <div id="characterGrid"></div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div>
                        <span class="panel-title">Historical Text (Original Manuscript)</span>
                        <span class="status loading" id="fontStatus">Font not loaded</span>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('historicalInput')">üìã Copy</button>
                </div>
                <textarea 
                    id="historicalInput" 
                    placeholder="Load the font first, then enter historical Japanese text (Â§â‰Ωì‰ªÆÂêç and historical variants)..."
                    oninput="updateCharCount('historicalInput', 'historicalCount')"></textarea>
                <div class="char-count" id="historicalCount">0 characters</div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Modern Japanese (Standardized)</span>
                    <button class="copy-btn" onclick="copyToClipboard('modernOutput')">üìã Copy</button>
                </div>
                <textarea 
                    id="modernOutput" 
                    placeholder="Converted modern Japanese will appear here..."
                    oninput="updateCharCount('modernOutput', 'modernCount')"></textarea>
                <div class="char-count" id="modernCount">0 characters</div>
            </div>
        </div>
    </div>

    <script>
        const hentaiganaMap = {
            '\u{1B001}': '„ÅÇ', '\u{1B002}': '„ÅÇ', '\u{1B003}': '„ÅÇ', '\u{1B004}': '„ÅÇ', '\u{1B005}': '„ÅÇ',
            '\u{1B006}': '„ÅÑ', '\u{1B007}': '„ÅÑ', '\u{1B008}': '„ÅÑ', '\u{1B009}': '„ÅÑ', '\u{1B00A}': '„ÅÑ', '\u{1B00B}': '„ÅÑ',
            '\u{1B00C}': '„ÅÜ', '\u{1B00D}': '„ÅÜ', '\u{1B00E}': '„ÅÜ', '\u{1B00F}': '„ÅÜ', '\u{1B010}': '„ÅÜ', '\u{1B011}': '„ÅÜ',
            '\u{1B012}': '„Åà', '\u{1B013}': '„Åà', '\u{1B014}': '„Åà', '\u{1B015}': '„Åà', '\u{1B016}': '„Åà', '\u{1B017}': '„Åà',
            '\u{1B018}': '„Åä', '\u{1B019}': '„Åä', '\u{1B01A}': '„Åä', '\u{1B01B}': '„Åä', '\u{1B01C}': '„Åä', '\u{1B01D}': '„Åä',
            '\u{1B01E}': '„Åã', '\u{1B01F}': '„Åã', '\u{1B020}': '„Åã', '\u{1B021}': '„Åã', '\u{1B022}': '„Åã', '\u{1B023}': '„Åã',
            '\u{1B024}': '„Åå', '\u{1B025}': '„Åå',
            '\u{1B026}': '„Åç', '\u{1B027}': '„Åç', '\u{1B028}': '„Åç', '\u{1B029}': '„Åç', '\u{1B02A}': '„Åç', '\u{1B02B}': '„Åç',
            '\u{1B02C}': '„Åé', '\u{1B02D}': '„Åé',
            '\u{1B02E}': '„Åè', '\u{1B02F}': '„Åè', '\u{1B030}': '„Åè', '\u{1B031}': '„Åè',
            '\u{1B032}': '„Åê',
            '\u{1B033}': '„Åë', '\u{1B034}': '„Åë', '\u{1B035}': '„Åë', '\u{1B036}': '„Åë', '\u{1B037}': '„Åë', '\u{1B038}': '„Åë',
            '\u{1B039}': '„Åí', '\u{1B03A}': '„Åí',
            '\u{1B03B}': '„Åì', '\u{1B03C}': '„Åì', '\u{1B03D}': '„Åì', '\u{1B03E}': '„Åì', '\u{1B03F}': '„Åì', '\u{1B040}': '„Åì',
            '\u{1B041}': '„Åî',
            '\u{1B042}': '„Åï', '\u{1B043}': '„Åï', '\u{1B044}': '„Åï', '\u{1B045}': '„Åï', '\u{1B046}': '„Åï', '\u{1B047}': '„Åï',
            '\u{1B048}': '„Åñ',
            '\u{1B049}': '„Åó', '\u{1B04A}': '„Åó', '\u{1B04B}': '„Åó', '\u{1B04C}': '„Åó', '\u{1B04D}': '„Åó', '\u{1B04E}': '„Åó',
            '\u{1B04F}': '„Åò',
            '\u{1B050}': '„Åô', '\u{1B051}': '„Åô', '\u{1B052}': '„Åô', '\u{1B053}': '„Åô', '\u{1B054}': '„Åô', '\u{1B055}': '„Åô',
            '\u{1B056}': '„Åö',
            '\u{1B057}': '„Åõ', '\u{1B058}': '„Åõ', '\u{1B059}': '„Åõ', '\u{1B05A}': '„Åõ', '\u{1B05B}': '„Åõ', '\u{1B05C}': '„Åõ',
            '\u{1B05D}': '„Åú',
            '\u{1B05E}': '„Åù', '\u{1B05F}': '„Åù', '\u{1B060}': '„Åù', '\u{1B061}': '„Åù', '\u{1B062}': '„Åù', '\u{1B063}': '„Åù',
            '\u{1B064}': '„Åû',
            '\u{1B065}': '„Åü', '\u{1B066}': '„Åü', '\u{1B067}': '„Åü', '\u{1B068}': '„Åü', '\u{1B069}': '„Åü',
            '\u{1B06A}': '„Å†',
            '\u{1B06B}': '„Å°', '\u{1B06C}': '„Å°', '\u{1B06D}': '„Å°', '\u{1B06E}': '„Å°', '\u{1B06F}': '„Å°',
            '\u{1B070}': '„Å¢',
            '\u{1B071}': '„Å§', '\u{1B072}': '„Å§', '\u{1B073}': '„Å§', '\u{1B074}': '„Å§',
            '\u{1B075}': '„Å•',
            '\u{1B076}': '„Å¶', '\u{1B077}': '„Å¶', '\u{1B078}': '„Å¶', '\u{1B079}': '„Å¶', '\u{1B07A}': '„Å¶',
            '\u{1B07B}': '„Åß',
            '\u{1B07C}': '„Å®', '\u{1B07D}': '„Å®', '\u{1B07E}': '„Å®', '\u{1B07F}': '„Å®', '\u{1B080}': '„Å®',
            '\u{1B081}': '„Å©',
            '\u{1B082}': '„Å™', '\u{1B083}': '„Å™', '\u{1B084}': '„Å™', '\u{1B085}': '„Å™', '\u{1B086}': '„Å™',
            '\u{1B087}': '„Å´', '\u{1B088}': '„Å´', '\u{1B089}': '„Å´', '\u{1B08A}': '„Å´',
            '\u{1B08B}': '„Å¨', '\u{1B08C}': '„Å¨', '\u{1B08D}': '„Å¨',
            '\u{1B08E}': '„Å≠', '\u{1B08F}': '„Å≠', '\u{1B090}': '„Å≠', '\u{1B091}': '„Å≠',
            '\u{1B092}': '„ÅÆ', '\u{1B093}': '„ÅÆ', '\u{1B094}': '„ÅÆ', '\u{1B095}': '„ÅÆ',
            '\u{1B096}': '„ÅØ', '\u{1B097}': '„ÅØ', '\u{1B098}': '„ÅØ', '\u{1B099}': '„ÅØ', '\u{1B09A}': '„ÅØ', '\u{1B09B}': '„ÅØ',
            '\u{1B09C}': '„Å∞', '\u{1B09D}': '„Å±',
            '\u{1B09E}': '„Å≤', '\u{1B09F}': '„Å≤', '\u{1B0A0}': '„Å≤', '\u{1B0A1}': '„Å≤', '\u{1B0A2}': '„Å≤',
            '\u{1B0A3}': '„Å≥', '\u{1B0A4}': '„Å≥', '\u{1B0A5}': '„Å¥',
            '\u{1B0A6}': '„Åµ', '\u{1B0A7}': '„Åµ', '\u{1B0A8}': '„Åµ', '\u{1B0A9}': '„Åµ',
            '\u{1B0AA}': '„Å∂', '\u{1B0AB}': '„Å∑',
            '\u{1B0AC}': '„Å∏', '\u{1B0AD}': '„Å∏', '\u{1B0AE}': '„Å∏', '\u{1B0AF}': '„Å∏',
            '\u{1B0B0}': '„Åπ', '\u{1B0B1}': '„Å∫',
            '\u{1B0B2}': '„Åª', '\u{1B0B3}': '„Åª', '\u{1B0B4}': '„Åª', '\u{1B0B5}': '„Åª', '\u{1B0B6}': '„Åª', '\u{1B0B7}': '„Åª',
            '\u{1B0B8}': '„Åº', '\u{1B0B9}': '„ÅΩ',
            '\u{1B0BA}': '„Åæ', '\u{1B0BB}': '„Åæ', '\u{1B0BC}': '„Åæ', '\u{1B0BD}': '„Åæ',
            '\u{1B0BE}': '„Åø', '\u{1B0BF}': '„Åø', '\u{1B0C0}': '„Åø', '\u{1B0C1}': '„Åø',
            '\u{1B0C2}': '„ÇÄ', '\u{1B0C3}': '„ÇÄ', '\u{1B0C4}': '„ÇÄ', '\u{1B0C5}': '„ÇÄ', '\u{1B0C6}': '„ÇÄ',
            '\u{1B0C7}': '„ÇÅ', '\u{1B0C8}': '„ÇÅ', '\u{1B0C9}': '„ÇÅ', '\u{1B0CA}': '„ÇÅ',
            '\u{1B0CB}': '„ÇÇ', '\u{1B0CC}': '„ÇÇ', '\u{1B0CD}': '„ÇÇ', '\u{1B0CE}': '„ÇÇ', '\u{1B0CF}': '„ÇÇ', '\u{1B0D0}': '„ÇÇ',
            '\u{1B0D1}': '„ÇÑ', '\u{1B0D2}': '„ÇÑ', '\u{1B0D3}': '„ÇÑ',
            '\u{1B0D4}': '„ÇÜ', '\u{1B0D5}': '„ÇÜ', '\u{1B0D6}': '„ÇÜ',
            '\u{1B0D7}': '„Çà', '\u{1B0D8}': '„Çà', '\u{1B0D9}': '„Çà', '\u{1B0DA}': '„Çà',
            '\u{1B0DB}': '„Çâ', '\u{1B0DC}': '„Çâ', '\u{1B0DD}': '„Çâ', '\u{1B0DE}': '„Çâ',
            '\u{1B0DF}': '„Çä', '\u{1B0E0}': '„Çä', '\u{1B0E1}': '„Çä', '\u{1B0E2}': '„Çä',
            '\u{1B0E3}': '„Çã', '\u{1B0E4}': '„Çã', '\u{1B0E5}': '„Çã',
            '\u{1B0E6}': '„Çå', '\u{1B0E7}': '„Çå', '\u{1B0E8}': '„Çå', '\u{1B0E9}': '„Çå',
            '\u{1B0EA}': '„Çç', '\u{1B0EB}': '„Çç', '\u{1B0EC}': '„Çç', '\u{1B0ED}': '„Çç', '\u{1B0EE}': '„Çç',
            '\u{1B0EF}': '„Çè', '\u{1B0F0}': '„Çè', '\u{1B0F1}': '„Çè',
            '\u{1B0F2}': '„Çê', '\u{1B0F3}': '„Çê', '\u{1B0F4}': '„Çê',
            '\u{1B0F5}': '„Çë', '\u{1B0F6}': '„Çë', '\u{1B0F7}': '„Çë', '\u{1B0F8}': '„Çë',
            '\u{1B0F9}': '„Çí', '\u{1B0FA}': '„Çí', '\u{1B0FB}': '„Çí',
            '\u{1B0FC}': '„Çì', '\u{1B0FD}': '„Çì', '\u{1B0FE}': '„Çì', '\u{1B0FF}': '„Çì', '\u{1B100}': '„Çì'
        };

        const historicalKanaMap = {
            '„Çê': '„ÅÑ', '„Çë': '„Åà', '„É∞': '„Ç§', '„É±': '„Ç®'
        };

        // Group hentaigana by modern equivalent for the picker
        const hentaiganaGroups = {
            '„ÅÇ': ['\u{1B002}', '\u{1B005}', '\u{1B003}', '\u{1B004}'],
            '„ÅÑ': ['\u{1B006}', '\u{1B007}', '\u{1B008}', '\u{1B009}'],
            '„ÅÜ': ['\u{1B00A}', '\u{1B00B}', '\u{1B00C}', '\u{1B00D}', '\u{1B00E}'],
            '„Åà': ['\u{1B001}', '\u{1B00F}', '\u{1B010}', '\u{1B011}', '\u{1B012}', '\u{1B013}'],
            '„Åä': ['\u{1B014}', '\u{1B015}', '\u{1B016}'],
            '„Åã': ['\u{1B017}', '\u{1B018}', '\u{1B019}', '\u{1B01A}', '\u{1B01B}', '\u{1B022}', '\u{1B01C}', '\u{1B01D}', '\u{1B01E}', '\u{1B01F}', '\u{1B020}', '\u{1B021}'],
            '„Åç': ['\u{1B023}', '\u{1B024}', '\u{1B025}', '\u{1B026}', '\u{1B027}', '\u{1B028}', '\u{1B02A}'],
            '„Åè': ['\u{1B02B}', '\u{1B02C}', '\u{1B02D}', '\u{1B02E}', '\u{1B02F}', '\u{1B030}', '\u{1B031}'],
            '„Åë': ['\u{1B033}', '\u{1B034}', '\u{1B035}', '\u{1B036}', '\u{1B037}'],
            '„Åì': ['\u{1B038}', '\u{1B039}', '\u{1B03B}', '\u{1B03A}'],
            '„Åï': ['\u{1B03C}', '\u{1B03D}', '\u{1B03E}', '\u{1B03F}', '\u{1B040}', '\u{1B041}', '\u{1B042}', '\u{1B043}'],
            '„Åó': ['\u{1B044}', '\u{1B045}', '\u{1B046}', '\u{1B047}', '\u{1B048}', '\u{1B049}'],
            '„Åô': ['\u{1B04A}', '\u{1B04B}', '\u{1B04C}', '\u{1B04D}', '\u{1B04E}', '\u{1B04F}', '\u{1B050}', '\u{1B051}'],
            '„Åõ': ['\u{1B052}', '\u{1B053}', '\u{1B055}', '\u{1B056}'],
            '„Åù': ['\u{1B057}', '\u{1B058}', '\u{1B059}', '\u{1B05A}', '\u{1B05B}', '\u{1B05C}', '\u{1B05D}'],
            '„Åü': ['\u{1B05E}', '\u{1B05F}', '\u{1B060}', '\u{1B061}'],
            '„Å°': ['\u{1B062}', '\u{1B063}', '\u{1B064}', '\u{1B066}', '\u{1B067}', '\u{1B068}'],
            '„Å§': ['\u{1B069}', '\u{1B06A}', '\u{1B06D}', '\u{1B06B}', '\u{1B06C}'],
            '„Å¶': ['\u{1B06E}', '\u{1B06F}', '\u{1B070}', '\u{1B071}', '\u{1B072}', '\u{1B073}', '\u{1B074}', '\u{1B075}', '\u{1B076}'],
            '„Å®': ['\u{1B077}', '\u{1B078}', '\u{1B079}', '\u{1B07A}', '\u{1B07B}', '\u{1B07C}', '\u{1B07D}'],
            '„Å™': ['\u{1B07E}', '\u{1B07F}', '\u{1B080}', '\u{1B081}', '\u{1B082}', '\u{1B083}', '\u{1B084}', '\u{1B085}', '\u{1B086}'],
            '„Å´': ['\u{1B087}', '\u{1B088}', '\u{1B089}', '\u{1B08A}', '\u{1B08B}', '\u{1B08C}', '\u{1B08E}', '\u{1B08D}'],
            '„Å¨': ['\u{1B08F}', '\u{1B091}'],
            '„Å≠': ['\u{1B098}', '\u{1B092}', '\u{1B094}', '\u{1B096}', '\u{1B097}'],
            '„ÅÆ': ['\u{1B099}', '\u{1B09A}', '\u{1B09B}', '\u{1B09C}', '\u{1B09D}'],
            '„ÅØ': ['\u{1B09E}', '\u{1B09F}', '\u{1B0A0}', '\u{1B0A1}', '\u{1B0A2}', '\u{1B0A3}', '\u{1B0A4}', '\u{1B0A5}', '\u{1B0A6}', '\u{1B0A7}', '\u{1B0A8}'],
            '„Å≤': ['\u{1B0A9}', '\u{1B0AA}', '\u{1B0AB}', '\u{1B0AC}', '\u{1B0AD}', '\u{1B0AE}', '\u{1B0AF}'],
            '„Åµ': ['\u{1B0B0}', '\u{1B0B1}', '\u{1B0B2}'],
            '„Å∏': ['\u{1B0B3}', '\u{1B0B5}', '\u{1B0B6}', '\u{1B0B7}', '\u{1B0B9}'],
            '„Åª': ['\u{1B0BA}', '\u{1B0BB}', '\u{1B0BC}', '\u{1B0BD}', '\u{1B0BE}', '\u{1B0C0}', '\u{1B0BF}'],
            '„Åæ': ['\u{1B0C2}', '\u{1B0C3}', '\u{1B0C4}', '\u{1B0C5}', '\u{1B0C6}', '\u{1B0C7}', '\u{1B0C8}'],
            '„Åø': ['\u{1B0C9}', '\u{1B0CA}', '\u{1B0CB}', '\u{1B0CC}', '\u{1B0CD}', '\u{1B0CE}', '\u{1B0CF}'],
            '„ÇÄ': ['\u{1B11E}', '\u{1B0D1}', '\u{1B0D2}', '\u{1B0D3}'],
            '„ÇÅ': ['\u{1B0D4}', '\u{1B0D5}', '\u{1B0D6}'],
            '„ÇÇ': ['\u{1B0D7}', '\u{1B0D8}', '\u{1B0D9}', '\u{1B0DA}', '\u{1B0DB}', '\u{1B0DC}'],
            '„ÇÑ': ['\u{1B0DD}', '\u{1B0DE}', '\u{1B0E2}', '\u{1B0DF}', '\u{1B0E1}'],
            '„ÇÜ': ['\u{1B0E4}', '\u{1B0E5}', '\u{1B0E6}'],
            '„Çà': ['\u{1B0E8}', '\u{1B0EA}', '\u{1B0EB}', '\u{1B0EC}'],
            '„Çâ': ['\u{1B0ED}', '\u{1B0EE}', '\u{1B0F0}'],
            '„Çä': ['\u{1B0F1}', '\u{1B0F2}', '\u{1B0F3}', '\u{1B0F4}', '\u{1B0F5}', '\u{1B0F6}', '\u{1B0F7}'],
            '„Çã': ['\u{1B0F8}', '\u{1B0F9}', '\u{1B0FA}', '\u{1B0FB}', '\u{1B0FC}', '\u{1B0FD}'],
            '„Çå': ['\u{1B0FE}', '\u{1B0FF}', '\u{1B100}', '\u{1B101}'],
            '„Çç': ['\u{1B102}', '\u{1B103}', '\u{1B104}', '\u{1B105}', '\u{1B106}', '\u{1B107}'],
            '„Çè': ['\u{1B108}', '\u{1B109}', '\u{1B10A}', '\u{1B10B}'],
            '„Çê': ['\u{1B10D}', '\u{1B10E}', '\u{1B111}'],
            '„Çë': ['\u{1B112}', '\u{1B113}', '\u{1B114}'],
            '„Çí': ['\u{1B116}', '\u{1B117}', '\u{1B118}', '\u{1B119}', '\u{1B11A}', '\u{1B11B}', '\u{1B11C}']
        };

        // Initialize character picker on page load
        window.addEventListener('DOMContentLoaded', () => {
            renderCharacterPicker();
        });

        function renderCharacterPicker(filter = '') {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';
            
            for (const [modern, variants] of Object.entries(hentaiganaGroups)) {
                // Skip if doesn't match filter
                if (filter && !modern.includes(filter)) continue;
                
                const group = document.createElement('div');
                group.className = 'kana-group';
                
                const title = document.createElement('div');
                title.className = 'kana-group-title';
                title.textContent = `${modern} variants (${variants.length})`;
                group.appendChild(title);
                
                const chars = document.createElement('div');
                chars.className = 'kana-chars';
                
                variants.forEach(char => {
                    const btn = document.createElement('button');
                    btn.className = 'kana-char';
                    btn.textContent = char;
                    btn.title = `Insert ${char} (variant of ${modern})`;
                    btn.onclick = () => insertCharacter(char);
                    chars.appendChild(btn);
                });
                
                group.appendChild(chars);
                grid.appendChild(group);
            }
            
            if (grid.innerHTML === '') {
                grid.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No characters match your search.</div>';
            }
        }

        function insertCharacter(char) {
            const textarea = document.getElementById('historicalInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + char + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + char.length;
            textarea.focus();
            
            updateCharCount('historicalInput', 'historicalCount');
        }

        function filterCharacters() {
            const filter = document.getElementById('pickerSearch').value;
            renderCharacterPicker(filter);
        }

        function togglePicker() {
            const picker = document.getElementById('characterPicker');
            const btn = event.target;
            
            if (picker.classList.contains('collapsed')) {
                picker.classList.remove('collapsed');
                btn.textContent = 'Collapse ‚ñ≤';
            } else {
                picker.classList.add('collapsed');
                btn.textContent = 'Expand ‚ñº';
            }
        }

        async function loadFont() {
            const btn = document.getElementById('loadFontBtn');
            const statusEl = document.getElementById('fontStatus');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const loadStatus = document.getElementById('fontLoadStatus');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading font...';
            statusEl.textContent = 'Loading...';
            statusEl.className = 'status loading';
            progressBar.classList.add('active');
            
            try {
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress >= 90) clearInterval(progressInterval);
                    progressFill.style.width = progress + '%';
                    loadStatus.textContent = `Loading... ${progress}%`;
                }, 100);

                // Try system-installed font first, then load from local server
                const font = new FontFace(
                    'IPAmj Mincho',
                    'local("IPAmj Mincho"), local("IPAmjMincho"), local("ipamjm"), url(ipamjm.ttf)'
                );
                await font.load();
                document.fonts.add(font);
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                loadStatus.textContent = 'Font loaded successfully! ‚úì';
                
                document.getElementById('historicalInput').classList.add('font-loaded');
                
                setTimeout(() => {
                    statusEl.textContent = 'Font loaded ‚úì';
                    statusEl.className = 'status ready';
                    document.getElementById('fontWarning').style.display = 'none';
                    btn.textContent = '‚úì Font Loaded';
                }, 500);
                
            } catch (error) {
                console.error('Font loading failed:', error);
                statusEl.textContent = 'Load failed';
                statusEl.className = 'status error';
                loadStatus.textContent = 'Failed to load font. Please refresh and try again.';
                btn.disabled = false;
                btn.textContent = 'üîÑ Retry Loading Font';
            }
        }

        function convertText() {
            let output = document.getElementById('historicalInput').value;
            for (const [h, m] of Object.entries(hentaiganaMap)) output = output.split(h).join(m);
            for (const [h, m] of Object.entries(historicalKanaMap)) output = output.split(h).join(m);
            document.getElementById('modernOutput').value = output;
            updateCharCount('modernOutput', 'modernCount');
        }

        function clearAll() {
            document.getElementById('historicalInput').value = '';
            document.getElementById('modernOutput').value = '';
            updateCharCount('historicalInput', 'historicalCount');
            updateCharCount('modernOutput', 'modernCount');
        }

        function swapTexts() {
            const h = document.getElementById('historicalInput').value;
            const m = document.getElementById('modernOutput').value;
            document.getElementById('historicalInput').value = m;
            document.getElementById('modernOutput').value = h;
            updateCharCount('historicalInput', 'historicalCount');
            updateCharCount('modernOutput', 'modernCount');
        }

        function downloadBoth() {
            const h = document.getElementById('historicalInput').value;
            const m = document.getElementById('modernOutput').value;
            const text = `=== Historical Text ===\n\n${h}\n\n\n=== Modern Japanese ===\n\n${m}`;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcription_' + new Date().toISOString().slice(0,10) + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            const btn = event.target;
            const orig = btn.textContent;
            btn.textContent = '‚úì Copied!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.textContent = orig;
                btn.style.background = '';
            }, 2000);
        }

        function updateCharCount(textareaId, countId) {
            const count = document.getElementById(textareaId).value.length;
            document.getElementById(countId).textContent = `${count} character${count !== 1 ? 's' : ''}`;
        }
    </script>
</body>
</html>